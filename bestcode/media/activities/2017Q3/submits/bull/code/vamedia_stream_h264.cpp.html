<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #333333 }
body  { background: #111111; color: #ffffff }
body .c { color: #008800; font-style: italic; background-color: #0f140f } /* Comment */
body .err { color: #ffffff } /* Error */
body .esc { color: #ffffff } /* Escape */
body .g { color: #ffffff } /* Generic */
body .k { color: #fb660a; font-weight: bold } /* Keyword */
body .l { color: #ffffff } /* Literal */
body .n { color: #ffffff } /* Name */
body .o { color: #ffffff } /* Operator */
body .x { color: #ffffff } /* Other */
body .p { color: #ffffff } /* Punctuation */
body .ch { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Hashbang */
body .cm { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Multiline */
body .cp { color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f } /* Comment.Preproc */
body .cpf { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.PreprocFile */
body .c1 { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Single */
body .cs { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Special */
body .gd { color: #ffffff } /* Generic.Deleted */
body .ge { color: #ffffff } /* Generic.Emph */
body .gr { color: #ffffff } /* Generic.Error */
body .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
body .gi { color: #ffffff } /* Generic.Inserted */
body .go { color: #444444; background-color: #222222 } /* Generic.Output */
body .gp { color: #ffffff } /* Generic.Prompt */
body .gs { color: #ffffff } /* Generic.Strong */
body .gu { color: #ffffff; font-weight: bold } /* Generic.Subheading */
body .gt { color: #ffffff } /* Generic.Traceback */
body .kc { color: #fb660a; font-weight: bold } /* Keyword.Constant */
body .kd { color: #fb660a; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #fb660a; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #fb660a } /* Keyword.Pseudo */
body .kr { color: #fb660a; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #cdcaa9; font-weight: bold } /* Keyword.Type */
body .ld { color: #ffffff } /* Literal.Date */
body .m { color: #0086f7; font-weight: bold } /* Literal.Number */
body .s { color: #0086d2 } /* Literal.String */
body .na { color: #ff0086; font-weight: bold } /* Name.Attribute */
body .nb { color: #ffffff } /* Name.Builtin */
body .nc { color: #ffffff } /* Name.Class */
body .no { color: #0086d2 } /* Name.Constant */
body .nd { color: #ffffff } /* Name.Decorator */
body .ni { color: #ffffff } /* Name.Entity */
body .ne { color: #ffffff } /* Name.Exception */
body .nf { color: #ff0086; font-weight: bold } /* Name.Function */
body .nl { color: #ffffff } /* Name.Label */
body .nn { color: #ffffff } /* Name.Namespace */
body .nx { color: #ffffff } /* Name.Other */
body .py { color: #ffffff } /* Name.Property */
body .nt { color: #fb660a; font-weight: bold } /* Name.Tag */
body .nv { color: #fb660a } /* Name.Variable */
body .ow { color: #ffffff } /* Operator.Word */
body .w { color: #888888 } /* Text.Whitespace */
body .mb { color: #0086f7; font-weight: bold } /* Literal.Number.Bin */
body .mf { color: #0086f7; font-weight: bold } /* Literal.Number.Float */
body .mh { color: #0086f7; font-weight: bold } /* Literal.Number.Hex */
body .mi { color: #0086f7; font-weight: bold } /* Literal.Number.Integer */
body .mo { color: #0086f7; font-weight: bold } /* Literal.Number.Oct */
body .sa { color: #0086d2 } /* Literal.String.Affix */
body .sb { color: #0086d2 } /* Literal.String.Backtick */
body .sc { color: #0086d2 } /* Literal.String.Char */
body .dl { color: #0086d2 } /* Literal.String.Delimiter */
body .sd { color: #0086d2 } /* Literal.String.Doc */
body .s2 { color: #0086d2 } /* Literal.String.Double */
body .se { color: #0086d2 } /* Literal.String.Escape */
body .sh { color: #0086d2 } /* Literal.String.Heredoc */
body .si { color: #0086d2 } /* Literal.String.Interpol */
body .sx { color: #0086d2 } /* Literal.String.Other */
body .sr { color: #0086d2 } /* Literal.String.Regex */
body .s1 { color: #0086d2 } /* Literal.String.Single */
body .ss { color: #0086d2 } /* Literal.String.Symbol */
body .bp { color: #ffffff } /* Name.Builtin.Pseudo */
body .fm { color: #ff0086; font-weight: bold } /* Name.Function.Magic */
body .vc { color: #fb660a } /* Name.Variable.Class */
body .vg { color: #fb660a } /* Name.Variable.Global */
body .vi { color: #fb660a } /* Name.Variable.Instance */
body .vm { color: #fb660a } /* Name.Variable.Magic */
body .il { color: #0086f7; font-weight: bold } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/* </span>
<span class="cm"> * h264bitstream - a library for reading and writing H.264 video</span>
<span class="cm"> * Copyright (C) 2005-2007 Auroras Entertainment, LLC</span>
<span class="cm"> * Copyright (C) 2008-2011 Avail-TVN</span>
<span class="cm"> * </span>
<span class="cm"> * Written by Alex Izvorski &lt;aizvorski@gmail.com&gt; and Alex Giladi &lt;alex.giladi@gmail.com&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * This library is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU Lesser General Public</span>
<span class="cm"> * License as published by the Free Software Foundation; either</span>
<span class="cm"> * version 2.1 of the License, or (at your option) any later version.</span>
<span class="cm"> * </span>
<span class="cm"> * This library is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * Lesser General Public License for more details.</span>
<span class="cm"> * </span>
<span class="cm"> * You should have received a copy of the GNU Lesser General Public</span>
<span class="cm"> * License along with this library; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&quot;vamedia_stream_h264.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="cp">#define   NOT_FIND_NAL_END_MAX_OFFSET   2048</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">g_ff_zigzag_direct</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
    <span class="mi">35</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span>
    <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">g_f_zigzag_scan</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="mi">0</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
    <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">34</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">g_default_scaling8</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span>
        <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span>
        <span class="mi">13</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
        <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>
        <span class="mi">18</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>
        <span class="mi">23</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
        <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span>
        <span class="mi">27</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">42</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>
        <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
        <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
        <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span>
        <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>
        <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
        <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>
        <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">35</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">IntLog2</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">log</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>    
        <span class="n">log</span><span class="o">++</span><span class="p">;</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">log</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">log</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span> <span class="n">log</span><span class="o">--</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">log</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">IsSliceType</span><span class="p">(</span><span class="kt">int</span> <span class="n">slice_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmp_type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slice_type</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">slice_type</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">cmp_type</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> 
        <span class="n">cmp_type</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">slice_type</span> <span class="o">==</span> <span class="n">cmp_type</span><span class="p">)</span> 
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>     
<span class="p">}</span>

<span class="cm">/***************************** reading ******************************/</span>

<span class="cm">/**</span>
<span class="cm"> Create a new H264 stream object.  Allocates all structures contained within it.</span>
<span class="cm"> @return    the stream object</span>
<span class="cm"> */</span>
<span class="n">H264Stream</span><span class="o">*</span> <span class="nf">NewH264Stream</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">H264Stream</span><span class="p">));</span>

    <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span> <span class="o">=</span> <span class="p">(</span><span class="n">NAL</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">NAL</span><span class="p">));</span>

    <span class="c1">// initialize tables</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SPS</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SPS</span><span class="p">));</span> 
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> 
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PPS</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PPS</span><span class="p">));</span> 
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SliceHeader</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SliceHeader</span><span class="p">));</span>
  
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span> <span class="o">=</span> <span class="p">(</span><span class="n">AUD</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AUD</span><span class="p">));</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_l0_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_l1_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="c1">//This is a TEMP pointer at whats in h-&gt;seis...</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>   
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> Free an existing H264 stream object.  Frees all contained structures.</span>
<span class="cm"> @param[in,out] h   the stream object</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">FreeH264Stream</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> 
        <span class="n">free</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span> 
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> 
        <span class="n">free</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span> 
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
        <span class="n">free</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span> 
    <span class="n">free</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SEI</span><span class="o">*</span> <span class="n">sei</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">FreeSEI</span><span class="p">(</span><span class="n">sei</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">free</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">free</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> Find the beginning and end of a NAL (Network Abstraction Layer) unit in a byte buffer containing H264 BitStream data.</span>
<span class="cm"> @param[in]   buf        the buffer</span>
<span class="cm"> @param[in]   size       the size of the buffer</span>
<span class="cm"> @param[out]  nal_start  the beginning offset of the nal</span>
<span class="cm"> @param[out]  nal_end    the end offset of the nal</span>
<span class="cm"> @return                 the length of the nal, or 0 if did not find start of nal, or -1 if did not find end of nal</span>
<span class="cm"> */</span>
<span class="c1">// DEPRECATED - this will be replaced by a similar function with a slightly different API</span>
<span class="kt">int</span> <span class="nf">FindNalUnit</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">nal_start</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">nal_end</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="c1">//  int max_offset = NOT_FIND_NAL_END_MAX_OFFSET &gt; size ? size : NOT_FIND_NAL_END_MAX_OFFSET;</span>
    <span class="c1">// find start</span>
    <span class="o">*</span><span class="n">nal_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">nal_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span>   <span class="c1">//( next_bits( 24 ) != 0x000001 &amp;&amp; next_bits( 32 ) != 0x00000001 )</span>
        <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
        <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> 
        <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span> <span class="c1">// skip leading zero</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> 
        <span class="p">{</span> 
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
        <span class="p">}</span> <span class="c1">// did not find nal start</span>
    <span class="p">}</span>

    <span class="k">if</span>  <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="c1">// ( next_bits( 24 ) != 0x000001 )</span>
    <span class="p">{</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span>  <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> 
    <span class="p">{</span> 
        <span class="cm">/* error, should never happen */</span> 
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="n">i</span><span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="o">*</span><span class="n">nal_start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    
    <span class="k">while</span> <span class="p">(</span>   <span class="c1">//( next_bits( 24 ) != 0x000000 &amp;&amp; next_bits( 24 ) != 0x000001 )</span>
        <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
        <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> 
        <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="c1">// FIXME the next line fails when reading a nal that ends exactly at the end of the data</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> 
        <span class="p">{</span> 
            <span class="o">*</span><span class="n">nal_end</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="c1">// did not find nal end, stream ended first</span>
    <span class="p">}</span>
    
    <span class="o">*</span><span class="n">nal_end</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">nal_end</span> <span class="o">-</span> <span class="o">*</span><span class="n">nal_start</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">MoreRBSPDataINPPS</span><span class="p">(</span><span class="n">H264Stream</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sps_id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span> <span class="o">*</span><span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">sps_id</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">profile_idc</span> <span class="o">=</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">66</span> <span class="o">||</span> <span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">77</span> <span class="o">||</span>
        <span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">88</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set_flags</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> 
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">MoreRBSPData</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">BSEOF</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="p">}</span>    
    <span class="k">if</span> <span class="p">(</span> <span class="n">BSPEEKU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
    <span class="p">}</span> <span class="c1">// if next bit is 1, we&#39;ve reached the stop bit</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">   Convert RBSP data to NAL data (Annex B format).</span>
<span class="cm">   The size of nal_buf must be 4/3 * the size of the rbsp_buf (rounded up) to guarantee the output will fit.</span>
<span class="cm">   If that is not true, output may be truncated and an error will be returned.</span>
<span class="cm">   If that is true, there is no possible error during this conversion.</span>
<span class="cm">   @param[in] rbsp_buf   the rbsp data</span>
<span class="cm">   @param[in] rbsp_size  pointer to the size of the rbsp data</span>
<span class="cm">   @param[in,out] nal_buf   allocated memory in which to put the nal data</span>
<span class="cm">   @param[in,out] nal_size  as input, pointer to the maximum size of the nal data; as output, filled in with the actual size of the nal data</span>
<span class="cm">   @return  actual size of nal data, or -1 on error</span>
<span class="cm"> */</span>
<span class="c1">// 7.3.1 NAL unit syntax</span>
<span class="c1">// 7.4.1.1 Encapsulation of an SODB within an RBSP</span>
<span class="kt">int</span> <span class="nf">RbspToNal</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">rbsp_buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">rbsp_size</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">nal_buf</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">nal_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nal_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">nal_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// zero out first byte since we start writing from second byte</span>

    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">rbsp_size</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">nal_size</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// error, not enough space</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFC</span><span class="p">)</span> <span class="p">)</span> <span class="c1">// HACK 0xFC</span>
        <span class="p">{</span>
            <span class="n">nal_buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
            <span class="n">j</span><span class="o">++</span><span class="p">;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nal_buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbsp_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">rbsp_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">nal_size</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">   Convert NAL data (Annex B format) to RBSP data.</span>
<span class="cm">   The size of rbsp_buf must be the same as size of the nal_buf to guarantee the output will fit.</span>
<span class="cm">   If that is not true, output may be truncated and an error will be returned. </span>
<span class="cm">   Additionally, certain byte sequences in the input nal_buf are not allowed in the spec and also cause the conversion to fail and an error to be returned.</span>
<span class="cm">   @param[in] nal_buf   the nal data</span>
<span class="cm">   @param[in,out] nal_size  as input, pointer to the size of the nal data; as output, filled in with the actual size of the nal data</span>
<span class="cm">   @param[in,out] rbsp_buf   allocated memory in which to put the rbsp data</span>
<span class="cm">   @param[in,out] rbsp_size  as input, pointer to the maximum size of the rbsp data; as output, filled in with the actual size of rbsp data</span>
<span class="cm">   @return  actual size of rbsp data, or -1 on error</span>
<span class="cm"> */</span>
<span class="c1">// 7.3.1 NAL unit syntax</span>
<span class="c1">// 7.4.1.1 Encapsulation of an SODB within an RBSP</span>
<span class="kt">int</span> <span class="nf">NaluToRbsp</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">nal_buf</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">nal_size</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">rbsp_buf</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">rbsp_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nal_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span> 
        <span class="c1">// in NAL unit, 0x000000, 0x000001 or 0x000002 shall not occur at any byte-aligned position</span>
        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nal_size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;nal = %d, i = %d,j = %d, nalbuf[i] = %02d %02d %02d %02d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">nal_size</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>           
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// check the 4th byte after 0x000003, except when cabac_zero_word is used, in which case the last three bytes of this NAL unit must be 0x000003</span>
            <span class="k">if</span><span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">nal_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x03</span><span class="p">))</span>
            <span class="p">{</span>
        <span class="c1">//      printf(&quot;nal 2, i = %d,j = %d, nalbuf[i] = %02d %02d %02d %02d \n&quot;,i,j,nal_buf[i-2],nal_buf[i-1],nal_buf[i],nal_buf[i+1]);</span>
                <span class="o">*</span><span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">j</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
                <span class="c1">// return -1;</span>
            <span class="p">}</span>

            <span class="c1">// if cabac_zero_word is used, the final byte of this NAL unit(0x03) is discarded, and the last two bytes of RBSP must be 0x0000</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">*</span><span class="n">nal_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">rbsp_size</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// error, not enough space</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">rbsp_buf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="n">nal_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">count</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">nal_size</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
    <span class="o">*</span><span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">j</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> Read a NAL unit from a byte buffer.</span>
<span class="cm"> The buffer must start exactly at the beginning of the nal (after the start prefix).</span>
<span class="cm"> The NAL is read into h-&gt;nal and into other fields within h depending on its type (check h-&gt;nal-&gt;nal_unit_type after reading).</span>
<span class="cm"> @param[in,out] h          the stream object</span>
<span class="cm"> @param[in]     buf        the buffer</span>
<span class="cm"> @param[in]     size       the size of the buffer</span>
<span class="cm"> @return                   the length of data actually read, or -1 on error</span>
<span class="cm"> */</span>
<span class="c1">//7.3.1 NAL unit syntax</span>
<span class="kt">int</span> <span class="nf">ReadNalUnit</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">;</span>
    <span class="n">BS</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">BSNew</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">forbidden_zero_bit</span> <span class="o">=</span> <span class="n">BSReadF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
    <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">nal_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">rbsp_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">rbsp_size</span><span class="p">);</span>
 
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">NaluToRbsp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nal_size</span><span class="p">,</span> <span class="n">rbsp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbsp_size</span><span class="p">);</span>
<span class="c1">//  printf(&quot;nal to rbsp ret: %d,nalsize is %d, rbsp_size is %d\n&quot;,rc,nal_size,rbsp_size);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">);</span> 
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
    <span class="p">}</span> <span class="c1">// handle conversion error</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">BSNew</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">,</span> <span class="n">rbsp_size</span><span class="p">);</span>
    <span class="c1">//printf(&quot;nal_unit_type: %d\n&quot;,nal-&gt;nal_unit_type);</span>

    <span class="k">switch</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_IDR</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_NON_IDR</span><span class="p">:</span>  
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_AUX</span><span class="p">:</span>
            <span class="n">ReadSliceHeader</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>            
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
            <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slice_data_size</span> <span class="o">=</span> <span class="n">nal_size</span><span class="p">;</span>            
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SliceHeader</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_SEI</span><span class="p">:</span>
            <span class="n">ReadSEIRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="p">;</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SEI</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_SPS</span><span class="p">:</span> 
            <span class="n">ReadSeqParamSetRbsp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> 
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SPS</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_PPS</span><span class="p">:</span>   
            <span class="n">ReadPicParamSetRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="p">;</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PPS</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_AUD</span><span class="p">:</span>     
            <span class="n">ReadAccessUnitDelimiterRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> 
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span><span class="p">;</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">AUD</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_END_OF_SEQUENCE</span><span class="p">:</span> 
            <span class="n">ReadEndOfSeqRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_END_OF_STREAM</span><span class="p">:</span> 
            <span class="n">ReadEndOfStreamRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">//case NAL_UNIT_TYPE_FILLER:</span>
        <span class="c1">//case NAL_UNIT_TYPE_SPS_EXT:</span>
        <span class="c1">//case NAL_UNIT_TYPE_UNSPECIFIED:</span>
        <span class="c1">//case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_A:  </span>
        <span class="c1">//case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_B: </span>
        <span class="c1">//case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_C:</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="c1">// here comes the reserved/unspecified/ignored stuff</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">parsed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">nal</span><span class="o">-&gt;</span><span class="n">sizeof_parsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//DebugNal(h,nal);</span>
<span class="c1">//     if (BSOverRun(b)) </span>
<span class="c1">//  {</span>
<span class="c1">//      BSFree(b); </span>
<span class="c1">//      free(rbsp_buf);</span>
<span class="c1">//      return -2;</span>
<span class="c1">//  }</span>

    <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> 
    <span class="n">free</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">nal_size</span><span class="p">;</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="cm">/**</span>
<span class="cm"> Read only the NAL headers (enough to determine unit type) from a byte buffer.</span>
<span class="cm"> @return unit type if read successfully, or -1 if this doesn&#39;t look like a nal</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">PeekNalUnit</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">;</span>

    <span class="n">BS</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">BSNew</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">forbidden_zero_bit</span> <span class="o">=</span> <span class="n">BSReadF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>

    <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="c1">// basic verification, per 7.4.1</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">forbidden_zero_bit</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">&lt;</span> <span class="mi">19</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_CODED_SLICE_IDR</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> 
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span>  <span class="n">NAL_UNIT_TYPE_SEI</span> <span class="o">||</span> 
             <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_AUD</span> <span class="o">||</span> 
             <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_END_OF_SEQUENCE</span> <span class="o">||</span> 
             <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_END_OF_STREAM</span> <span class="o">||</span> 
             <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_FILLER</span> <span class="p">)</span> 
        <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DecodeScalingList</span><span class="p">(</span><span class="n">TBitStream</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">factors</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
                         <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">jvt_list</span><span class="p">,</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">fallback_list</span><span class="p">)</span>
<span class="p">{</span><span class="c1">// 参考ffmpeg3.2.4代码</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">next</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">scan</span> <span class="o">=</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">?</span> <span class="nl">g_f_zigzag_scan</span> <span class="p">:</span> <span class="n">g_ff_zigzag_direct</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="cm">/* matrix not written, we use the predicted one */</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">fallback_list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">last</span> <span class="o">+</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">next</span><span class="p">)</span> 
            <span class="p">{</span> <span class="cm">/* matrix not written, we use the preset one */</span>
                <span class="n">memcpy</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">jvt_list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next</span> <span class="o">?</span> <span class="nl">next</span> <span class="p">:</span> <span class="n">last</span><span class="p">;</span>

        <span class="p">}</span>
    <span class="p">}</span>    
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DecodeScalingMatrices</span><span class="p">(</span><span class="n">TBitStream</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="k">const</span> <span class="n">SPS</span> <span class="o">*</span><span class="n">sps</span><span class="p">,</span> <span class="k">const</span> <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span><span class="p">,</span>
                            <span class="kt">int</span> <span class="n">is_sps</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="p">(</span><span class="o">*</span><span class="n">scaling_matrix4</span><span class="p">)[</span><span class="mi">16</span><span class="p">],</span> <span class="kt">uint8_t</span><span class="p">(</span><span class="o">*</span><span class="n">scaling_matrix8</span><span class="p">)[</span><span class="mi">64</span><span class="p">])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fallback_sps</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_sps</span> <span class="o">&amp;&amp;</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_scaling_matrix_present_flag</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">fallback</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> 
    <span class="p">{</span>
        <span class="n">fallback_sps</span> <span class="o">?</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">fallback_sps</span> <span class="o">?</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">fallback_sps</span> <span class="o">?</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">g_default_scaling8</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">fallback_sps</span> <span class="o">?</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">g_default_scaling8</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">};</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">is_sps</span><span class="p">;</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>        <span class="c1">// Intra, Y</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">// Intra, Cr</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">// Intra, Cb</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>        <span class="c1">// Inter, Y</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="c1">// Inter, Cr</span>
        <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">g_default_scaling4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scaling_matrix4</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span> <span class="c1">// Inter, Cb</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_sps</span> <span class="o">||</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">transform_8x8_mode_flag</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix8</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">64</span><span class="p">,</span> <span class="n">g_default_scaling8</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="c1">// Intra, Y</span>
            <span class="n">DecodeScalingList</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">scaling_matrix8</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">64</span><span class="p">,</span> <span class="n">g_default_scaling8</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span> <span class="c1">// Inter, Y            </span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//7.3.2.1 Sequence parameter set RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadSeqParamSetRbsp</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="c1">// NOTE can&#39;t read directly into sps because seq_parameter_set_id not yet known and so sps is not selected</span>

    <span class="kt">int</span> <span class="n">profile_idc</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">constraint_set_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// constraint_set0_flag</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>   <span class="c1">// constraint_set1_flag</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>   <span class="c1">// constraint_set2_flag</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>   <span class="c1">// constraint_set3_flag</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>   <span class="c1">// constraint_set4_flag</span>
    <span class="n">constraint_set_flags</span> <span class="o">|=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>   <span class="c1">// constraint_set5_flag</span>
    
    <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>  <span class="cm">/* all 0&#39;s */</span>    
    <span class="kt">int</span> <span class="n">level_idc</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">seq_parameter_set_id</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="c1">// select the correct sps</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">seq_parameter_set_id</span><span class="p">];</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">sps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SPS</span><span class="p">));</span>
    
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 420</span>

    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span><span class="p">;</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">;</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">=</span> <span class="n">profile_idc</span><span class="p">;</span> <span class="c1">// BSReadU8(b);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set_flags</span> <span class="o">=</span> <span class="n">constraint_set_flags</span><span class="p">;</span> 
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">level_idc</span> <span class="o">=</span> <span class="n">level_idc</span><span class="p">;</span> <span class="c1">//BSReadU8(b);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span> <span class="o">=</span> <span class="n">seq_parameter_set_id</span><span class="p">;</span> <span class="c1">// BSReadUE(b);</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">));</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">));</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_scaling_matrix_present_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span>  <span class="c1">// High profile</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">110</span> <span class="o">||</span>  <span class="c1">// High10 profile</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">122</span> <span class="o">||</span>  <span class="c1">// High422 profile</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">244</span> <span class="o">||</span>  <span class="c1">// High444 Predictive profile</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">44</span>  <span class="o">||</span>  <span class="c1">// Cavlc444 profile</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">83</span>  <span class="o">||</span>  <span class="c1">// Scalable Constrained High profile (SVC)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">86</span>  <span class="o">||</span>  <span class="c1">// Scalable High Intra profile (SVC)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">118</span> <span class="o">||</span>  <span class="c1">// Stereo High profile (MVC)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">128</span> <span class="o">||</span>  <span class="c1">// Multiview High profile (MVC)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">138</span> <span class="o">||</span>  <span class="c1">// Multiview Depth High profile (MVCD)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">144</span><span class="p">)</span>    <span class="c1">// old High444 profile</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span><span class="c1">//444  </span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">residual_colour_transform_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_luma_minus8</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_chroma_minus8</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">qpprime_y_zero_transform_bypass_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_scaling_matrix_present_flag</span> <span class="o">|=</span> 
            <span class="n">DecodeScalingMatrices</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> 
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_luma_minus8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_chroma_minus8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_frame_num_minus4</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>  

    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_pic_order_cnt_lsb</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">delta_pic_order_always_zero_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_non_ref_pic</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_top_to_bottom_field</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames_in_pic_order_cnt_cycle</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames_in_pic_order_cnt_cycle</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_ref_frame</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>        
    <span class="p">}</span>

    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">gaps_in_frame_num_value_allowed_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_width_in_mbs_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_height_in_map_units_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">mb_adaptive_frame_field_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">direct_8x8_inference_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_cropping_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_cropping_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_left_offset</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_right_offset</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_top_offset</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_bottom_offset</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui_parameters_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui_parameters_present_flag</span> <span class="p">)</span>
        <span class="n">ReadVUIParam</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    
    <span class="n">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//7.3.2.1.1 Scaling list syntax</span>
<span class="kt">void</span> <span class="nf">ReadScalingList</span><span class="p">(</span><span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">scalingList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sizeOfScalingList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useDefaultScalingMatrixFlag</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">scalingList</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;list is null!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">lastScale</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nextScale</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sizeOfScalingList</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>        
        <span class="k">if</span><span class="p">(</span> <span class="n">nextScale</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">delta_scale</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            
            <span class="n">nextScale</span> <span class="o">=</span> <span class="p">(</span> <span class="n">lastScale</span> <span class="o">+</span> <span class="n">delta_scale</span> <span class="o">+</span> <span class="mi">256</span> <span class="p">)</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
            <span class="n">useDefaultScalingMatrixFlag</span> <span class="o">=</span> <span class="p">(</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nextScale</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">);</span>            
        <span class="p">}</span>
        <span class="n">scalingList</span><span class="p">[</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">nextScale</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">?</span> <span class="nl">lastScale</span> <span class="p">:</span> <span class="n">nextScale</span><span class="p">;</span>        
        <span class="n">lastScale</span> <span class="o">=</span> <span class="n">scalingList</span><span class="p">[</span> <span class="n">j</span> <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Appendix E.1.1 VUI parameters syntax</span>
<span class="kt">void</span> <span class="nf">ReadVUIParam</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>

    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_info_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_idc</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_idc</span> <span class="o">==</span> <span class="n">SAR_EXTENDED</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_width</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_height</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_info_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_appropriate_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_sigNALype_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_sigNALype_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_format</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_full_range_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_description_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_description_present_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_primaries</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">transfer_characteristics</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">matrix_coefficients</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_loc_info_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_loc_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_top_field</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_bottom_field</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">timing_info_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">timing_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_units_in_tick</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">32</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">time_scale</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">32</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">fixed_frame_rate_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ReadHRDParam</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ReadHRDParam</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="o">||</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">low_delay_hrd_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">pic_struct_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">bitstream_restriction_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">bitstream_restriction_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">motion_vectors_over_pic_boundaries_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bytes_per_pic_denom</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bits_per_mb_denom</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_horizontal</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_vertical</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_reorder_frames</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_dec_frame_buffering</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>


<span class="c1">//Appendix E.1.2 HRD parameters syntax</span>
<span class="kt">void</span> <span class="nf">ReadHRDParam</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_scale</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_scale</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iSchedSelIdx</span> <span class="o">&lt;=</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span><span class="p">;</span> <span class="n">iSchedSelIdx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cbr_flag</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">initial_cpb_removal_delay_length_minus1</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_removal_delay_length_minus1</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">dpb_output_delay_length_minus1</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">time_offset_length</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">UNIMPLEMENTED</span>
<span class="cm">//7.3.2.1.2 Sequence parameter set extension RBSP syntax</span>
<span class="cm">int read_seq_parameter_set_extension_rbsp(BS* b, sps_ext_t* sps_ext) {</span>
<span class="cm">    seq_parameter_set_id = BSReadUE(b);</span>
<span class="cm">    aux_format_idc = BSReadUE(b);</span>
<span class="cm">    if( aux_format_idc != 0 ) {</span>
<span class="cm">        bit_depth_aux_minus8 = BSReadUE(b);</span>
<span class="cm">        alpha_incr_flag = BSReadU1(b);</span>
<span class="cm">        alpha_opaque_value = BSReadU(v);</span>
<span class="cm">        alpha_transparent_value = BSReadU(v);</span>
<span class="cm">    }</span>
<span class="cm">    additional_extension_flag = BSReadU1(b);</span>
<span class="cm">    ReadRBSPTrailingBits();</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="c1">//7.3.2.2 Picture parameter set RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadPicParamSetRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">i_group</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pps_id</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">qp_bd_offset</span><span class="p">;</span>
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="n">pps_id</span><span class="p">];</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">pps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PPS</span><span class="p">));</span>

    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span><span class="p">;</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">;</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span> <span class="o">=</span> <span class="n">pps_id</span><span class="p">;</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_group</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span><span class="p">;</span> <span class="n">i_group</span><span class="o">++</span> <span class="p">)</span>            
                <span class="n">pps</span><span class="o">-&gt;</span><span class="n">run_length_minus1</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>            
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_group</span> <span class="o">&lt;</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span><span class="p">;</span> <span class="n">i_group</span><span class="o">++</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">pps</span><span class="o">-&gt;</span><span class="n">top_left</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="n">pps</span><span class="o">-&gt;</span><span class="n">bottom_right</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span>
                 <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span>
                 <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_direction_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_rate_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
                <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_id</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">IntLog2</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span> 
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_pred_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_bipred_idc</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    
    <span class="n">qp_bd_offset</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_luma_minus8</span><span class="p">;</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qp_minus26</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">qp_bd_offset</span><span class="p">;;</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qs_minus26</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">qp_bd_offset</span><span class="p">;;</span>
    
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">chroma_qp_index_offset</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">deblocking_filter_control_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">constrained_intra_pred_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt_present_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">];</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">));</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">));</span>

    <span class="n">pps</span><span class="o">-&gt;</span><span class="n">more_rbsp_data_present</span> <span class="o">=</span> <span class="n">MoreRBSPDataINPPS</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">more_rbsp_data_present</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">pps</span><span class="o">-&gt;</span><span class="n">transform_8x8_mode_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">DecodeScalingMatrices</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="p">,</span> <span class="n">pps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList4x4</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">ScalingList8x8</span><span class="p">);</span>
        <span class="n">pps</span><span class="o">-&gt;</span><span class="n">second_chroma_qp_index_offset</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//7.3.2.3 Supplemental enhancement information RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadSEIRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FreeSEI</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span><span class="o">++</span><span class="p">;</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span> <span class="o">=</span> <span class="p">(</span><span class="n">SEI</span><span class="o">**</span><span class="p">)</span><span class="n">realloc</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SEI</span><span class="o">*</span><span class="p">));</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewSEI</span><span class="p">();</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">ReadSEIMessage</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">MoreRBSPData</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">);</span>
   <span class="c1">// ReadRBSPTrailingBits(h, b);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ReadFFCodedNumber</span><span class="p">(</span><span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">n1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n2</span><span class="p">;</span>
    <span class="k">do</span> 
    <span class="p">{</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">BSReadU8</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">n1</span> <span class="o">+=</span> <span class="n">n2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n2</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">n1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//7.3.2.3.1 Supplemental enhancement information message syntax</span>
<span class="kt">void</span> <span class="nf">ReadSEIMessage</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_type</span> <span class="o">=</span> <span class="n">ReadFFCodedNumber</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="o">=</span> <span class="n">ReadFFCodedNumber</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">ReadSEIPayload</span><span class="p">(</span> <span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_type</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.4 Access unit delimiter RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadAccessUnitDelimiterRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span><span class="o">-&gt;</span><span class="n">primary_pic_type</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.5 End of sequence RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadEndOfSeqRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">//7.3.2.6 End of stream RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadEndOfStreamRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">//7.3.2.7 Filler data RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadFilterDataRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">BSNextBits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="p">)</span>
    <span class="p">{</span>
    <span class="c1">//  int ff_byte = 0;</span>
        <span class="n">BSReadF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>  <span class="c1">// equal to 0xFF</span>
    <span class="p">}</span>
    <span class="n">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.8 Slice layer without partitioning RBSP syntax</span>
<span class="kt">void</span> <span class="nf">ReadSliceLayerRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span>  <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ReadSliceHeader</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="n">SliceDataRbsp</span><span class="o">*</span> <span class="n">slice_data</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">slice_data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">slice_data</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_buf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="n">free</span><span class="p">(</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_buf</span> <span class="p">);</span> 
        <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">sptr</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="o">!!</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bits_left</span><span class="p">);</span> <span class="c1">// CABAC-specific: skip alignment bits, if there are any</span>
        <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">sptr</span><span class="p">;</span>
        
        <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_size</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_buf</span><span class="p">,</span> <span class="n">sptr</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_size</span> <span class="p">);</span>
        <span class="c1">// ugly hack: since next NALU starts at byte border, we are going to be padded by trailing_bits;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// FIXME should read or skip data</span>
    <span class="c1">//slice_data( ); /* all categories of slice_data( ) syntax */</span>
    <span class="n">ReadRBSPSliceTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">// UNIMPLEMENTED</span>
<span class="cm">//7.3.2.9.1 Slice data PARTITION A RBSP syntax</span>
<span class="cm">slice_data_partition_a_layer_rbsp( ) {</span>
<span class="cm">    ReadSliceHeader( );             // only category 2</span>
<span class="cm">    slice_id = BSReadUE(b)</span>
<span class="cm">    read_slice_data( );               // only category 2</span>
<span class="cm">    ReadRBSPSliceTrailingBits( ); // only category 2</span>
<span class="cm">}</span>

<span class="cm">//7.3.2.9.2 Slice data PARTITION B RBSP syntax</span>
<span class="cm">slice_data_partition_b_layer_rbsp( ) {</span>
<span class="cm">    slice_id = BSReadUE(b);    // only category 3</span>
<span class="cm">    if( redundant_pic_cnt_present_flag )</span>
<span class="cm">        redundant_pic_cnt = BSReadUE(b);</span>
<span class="cm">    read_slice_data( );               // only category 3</span>
<span class="cm">    ReadRBSPSliceTrailingBits( ); // only category 3</span>
<span class="cm">}</span>

<span class="cm">//7.3.2.9.3 Slice data PARTITION C RBSP syntax</span>
<span class="cm">slice_data_partition_c_layer_rbsp( ) {</span>
<span class="cm">    slice_id = BSReadUE(b);    // only category 4</span>
<span class="cm">    if( redundant_pic_cnt_present_flag )</span>
<span class="cm">        redundant_pic_cnt = BSReadUE(b);</span>
<span class="cm">    read_slice_data( );               // only category 4</span>
<span class="cm">    rbsp_slice_trailing_bits( ); // only category 4</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="kt">int</span>
<span class="nf">MoreRBSPTrailingData</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">BSEOF</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="p">}</span>

<span class="c1">//7.3.2.10 RBSP slice trailing bits syntax</span>
<span class="kt">void</span> <span class="nf">ReadRBSPSliceTrailingBits</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
  <span class="c1">//  int cabac_zero_word;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span> <span class="n">MoreRBSPTrailingData</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//cabac_zero_word = </span>
            <span class="n">BSReadF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">16</span><span class="p">);</span> <span class="c1">// equal to 0x0000</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.2.11 RBSP trailing bits syntax</span>
<span class="kt">void</span> <span class="nf">ReadRBSPTrailingBits</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//    int rbsp_stop_one_bit = </span>
    <span class="n">BSReadU1</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span> <span class="c1">// equal to 1</span>

    <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">BSByteAligned</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//int rbsp_alignment_zero_bit = </span>
        <span class="n">BSReadU1</span><span class="p">(</span> <span class="n">b</span> <span class="p">);</span> <span class="c1">// equal to 0</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.3 Slice header syntax</span>
<span class="kt">void</span> <span class="nf">ReadSliceHeader</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>    
    <span class="n">memset</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SliceHeader</span><span class="p">));</span>
    
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">// h-&gt;sps;</span>
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span><span class="c1">//h-&gt;pps;</span>
    <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">;</span>

    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">first_mb_in_slice</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span><span class="p">];</span>
    <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">level_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">frame_num</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_frame_num_minus4</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">);</span> <span class="c1">// was u(v)</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">bottom_field_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">idr_pic_id</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_lsb</span> <span class="o">=</span> <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_pic_order_cnt_lsb</span> <span class="p">);</span> <span class="c1">// was u(v)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>        
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt_bottom</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>   
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">delta_pic_order_always_zero_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>       
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt_present_flag</span> <span class="p">)</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">direct_spatial_mv_pred_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">num_ref_l0_frames</span> <span class="o">=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_P</span> <span class="p">)</span> <span class="o">||</span> 
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="o">||</span> 
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span><span class="c1">// 没有处理list1的情况，暂时不支持b帧</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_active_override_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>        
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_active_override_flag</span> <span class="p">)</span>
        <span class="p">{</span><span class="c1">// 需要重载参考引用帧计数</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="c1">// FIXME does this modify the pps?</span>
            <span class="n">num_ref_l0_frames</span> <span class="o">=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>            
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>    <span class="c1">// I帧重置引用帧数</span>
        <span class="n">num_ref_l0_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_l0_frames</span> <span class="o">!=</span> <span class="n">num_ref_l0_frames</span><span class="p">)</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_l0_frames</span> <span class="o">=</span> <span class="n">num_ref_l0_frames</span><span class="p">;</span>

    <span class="n">ReadRefPicListRecorder</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="c1">//  printf(&quot;first_mb[%d] pre weight left pos: %d\n&quot;,sh-&gt;first_mb_in_slice,BSPos(b)*BIT_OF_ONE_BYTE + (BIT_OF_ONE_BYTE - b-&gt;bits_left));</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_pred_flag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_P</span> <span class="p">)</span> <span class="o">||</span> 
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_bipred_idc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>        
        <span class="n">ReadPredWeightTable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="c1">//  printf(&quot;read weight left pos: %d\n&quot;,BSPos(b)*BIT_OF_ONE_BYTE + (BIT_OF_ONE_BYTE - b-&gt;bits_left));</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//printf(&quot; nal_ref_idc = %d\n&quot;, nal-&gt;nal_ref_idc);</span>
        <span class="n">ReadDecRefPicMarking</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_I</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> 
        <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">cabac_init_idc</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="c1">//printf(&quot;cabac_init_idc = %d\n&quot;, sh-&gt;cabac_init_idc);</span>
    <span class="p">}</span>
    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qp_delta</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
   <span class="c1">// printf(&quot;read slice_qp_delta left pos: %d\n&quot;,BSPos(b)*BIT_OF_ONE_BYTE + (BIT_OF_ONE_BYTE - b-&gt;bits_left));</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="o">||</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sp_for_switch_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qs_delta</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">deblocking_filter_control_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disable_deblocking_filter_idc</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disable_deblocking_filter_idc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_alpha_c0_offset_div2</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_beta_offset_div2</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
        
    <span class="c1">//printf(&quot;read num_slice_groups_minus1: %d, slice_gruop_map_type: %d, left pos: %d\n&quot;,</span>
    <span class="c1">//    pps-&gt;num_slice_groups_minus1,pps-&gt;slice_group_map_type, BSPos(b)*BIT_OF_ONE_BYTE + (BIT_OF_ONE_BYTE - b-&gt;bits_left));</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_group_change_cycle</span> <span class="o">=</span> 
            <span class="n">BSReadU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">IntLog2</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span> <span class="o">+</span>  
                                  <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_rate_minus1</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span> <span class="c1">// was u(v) // FIXME add 2?</span>
    <span class="p">}</span>

  <span class="c1">//  printf(&quot;End left pos: %d\n&quot;, BSPos(b)*BIT_OF_ONE_BYTE + (BIT_OF_ONE_BYTE - b-&gt;bits_left));</span>

    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_data_bit_offset</span> <span class="o">=</span> <span class="n">BSPos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">BIT_OF_ONE_BYTE</span> <span class="o">+</span> <span class="p">(</span><span class="n">BIT_OF_ONE_BYTE</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">bits_left</span><span class="p">)</span> <span class="o">+</span> <span class="n">BIT_OF_ONE_BYTE</span><span class="p">;</span>

   <span class="c1">// DebugSliceHeader(sh);</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//7.3.3.1 Reference picture list reordering syntax</span>
<span class="kt">void</span> <span class="nf">ReadRefPicListRecorder</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">memset</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsSliceType</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_I</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IsSliceType</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span><span class="p">))</span>
    <span class="p">{</span>
     <span class="c1">//   BSReadUE</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l0</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">long_term_pic_num</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BSEOF</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l1</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">long_term_pic_num</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">BSEOF</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.3.2 Prediction weight table syntax</span>
<span class="kt">void</span> <span class="nf">ReadPredWeightTable</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_log2_weight_denom</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_log2_weight_denom</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="c1">// 这里有错误， 循环不能使用ref数，因为前几次没有这么多引用帧。</span>
   
    <span class="c1">//printf(&quot;luma_log2_weight_denom  = %d\n&quot;,sh-&gt;PredWeightTable.luma_log2_weight_denom );</span>
    <span class="c1">//printf(&quot;chroma_log2_weight_denom  = %d\n&quot;,sh-&gt;PredWeightTable.chroma_log2_weight_denom );</span>
    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_ref_l0_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">luma_weight_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
       <span class="c1">// printf(&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; %d/%d luma flag: %d\n&quot;, i,h-&gt;num_ref_l0_frames,luma_weight_flag);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">luma_weight_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>  
            <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">!=</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_log2_weight_denom</span> <span class="o">||</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
                   <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_log2_weight_denom</span><span class="p">;</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

     <span class="c1">//   printf(&quot;ref[%d] luma_weight_l0: %d\n&quot;,i ,sh-&gt;PredWeightTable.luma_weight_l0[ i ]);</span>
     <span class="c1">//   printf(&quot;ref[%d] luma_offset_l0: %d\n&quot;,i, sh-&gt;PredWeightTable.luma_offset_l0[ i ]);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">chroma_weight_l0_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">chroma_weight_l0_flag</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">!=</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_log2_weight_denom</span><span class="o">||</span>
                        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
                        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> 
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_log2_weight_denom</span><span class="p">;</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>    
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]</span> <span class="o">=</span> <span class="n">BSReadSE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//7.3.3.3 Decoded reference picture marking syntax</span>
<span class="kt">void</span> <span class="nf">ReadDecRefPicMarking</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="c1">// FIXME should be an array</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">no_output_of_prior_pics_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_reference_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="c1">//      if(sh-&gt;DecRefPicMarking.long_term_reference_flag)</span>
<span class="c1">//          printf(&quot;no_output: %d,long_term_ref_flag: %d\n&quot;,sh-&gt;DecRefPicMarking.no_output_of_prior_pics_flag,sh-&gt;DecRefPicMarking.long_term_reference_flag);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">adaptive_ref_pic_marking_mode_flag</span> <span class="o">=</span> <span class="n">BSReadU1</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="c1">//      if(sh-&gt;DecRefPicMarking.adaptive_ref_pic_marking_mode_flag)</span>
<span class="c1">//          printf(&quot;adaptive_ref_pic_marking_mode_flag: %d\n&quot;,sh-&gt;DecRefPicMarking.adaptive_ref_pic_marking_mode_flag);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">adaptive_ref_pic_marking_mode_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">difference_of_pic_nums_minus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_pic_num</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_frame_idx</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">max_long_term_frame_idx_plus1</span> <span class="o">=</span> <span class="n">BSReadUE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
                <span class="p">}</span>
<span class="c1">//              printf(&quot; memory_management_control_operation: %d\n&quot;,sh-&gt;DecRefPicMarking.memory_management_control_operation);</span>
<span class="c1">//              printf(&quot;  difference_of_pic_nums_minus1: %d\n&quot;,sh-&gt;DecRefPicMarking.difference_of_pic_nums_minus1);</span>
<span class="c1">//              printf(&quot;  long_term_frame_idx: %d\n&quot;,sh-&gt;DecRefPicMarking.long_term_frame_idx);</span>
<span class="c1">//              printf(&quot;  long_term_pic_num: %d\n&quot;,sh-&gt;DecRefPicMarking.long_term_pic_num);</span>
<span class="c1">//              printf(&quot;  max_long_term_frame_idx_plus1: %d\n&quot;,sh-&gt;DecRefPicMarking.max_long_term_frame_idx_plus1);</span>
                
            <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">BSEOF</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">// UNIMPLEMENTED</span>
<span class="cm">//7.3.4 Slice data syntax</span>
<span class="cm">slice_data( )</span>
<span class="cm">{</span>
<span class="cm">    if( pps-&gt;entropy_coding_mode_flag )</span>
<span class="cm">        while( !byte_aligned( ) )</span>
<span class="cm">            cabac_alignment_one_bit = BSReadF(1);</span>
<span class="cm">    CurrMbAddr = first_mb_in_slice * ( 1 + MbaffFrameFlag );</span>
<span class="cm">    moreDataFlag = 1;</span>
<span class="cm">    prevMbSkipped = 0;</span>
<span class="cm">    do {</span>
<span class="cm">        if( ! IsSliceType( sh-&gt;slice_type, SH_SLICE_TYPE_I ) &amp;&amp; ! IsSliceType( sh-&gt;slice_type, SH_SLICE_TYPE_SI ) )</span>
<span class="cm">            if( !pps-&gt;entropy_coding_mode_flag ) {</span>
<span class="cm">                mb_skip_run = BSReadUE(b);</span>
<span class="cm">                prevMbSkipped = ( mb_skip_run &gt; 0 );</span>
<span class="cm">                for( i=0; i&lt;mb_skip_run; i++ )</span>
<span class="cm">                    CurrMbAddr = NextMbAddress( CurrMbAddr );</span>
<span class="cm">                moreDataFlag = MoreRBSPData( );</span>
<span class="cm">            } else {</span>
<span class="cm">                mb_skip_flag = bs_read_ae(v);</span>
<span class="cm">                moreDataFlag = !mb_skip_flag;</span>
<span class="cm">            }</span>
<span class="cm">        if( moreDataFlag ) {</span>
<span class="cm">            if( MbaffFrameFlag &amp;&amp; ( CurrMbAddr % 2 == 0 ||</span>
<span class="cm">                                    ( CurrMbAddr % 2 == 1 &amp;&amp; prevMbSkipped ) ) )</span>
<span class="cm">                mb_field_decoding_flag = BSReadU1(b) | bs_read_ae(v);</span>
<span class="cm">            macroblock_layer( );</span>
<span class="cm">        }</span>
<span class="cm">        if( !pps-&gt;entropy_coding_mode_flag )</span>
<span class="cm">            moreDataFlag = MoreRBSPData( );</span>
<span class="cm">        else {</span>
<span class="cm">            if( ! IsSliceType( sh-&gt;slice_type, SH_SLICE_TYPE_I ) &amp;&amp; ! IsSliceType( sh-&gt;slice_type, SH_SLICE_TYPE_SI ) )</span>
<span class="cm">                prevMbSkipped = mb_skip_flag;</span>
<span class="cm">            if( MbaffFrameFlag &amp;&amp; CurrMbAddr % 2 == 0 )</span>
<span class="cm">                moreDataFlag = 1;</span>
<span class="cm">            else {</span>
<span class="cm">                end_of_slice_flag = bs_read_ae(v);</span>
<span class="cm">                moreDataFlag = !end_of_slice_flag;</span>
<span class="cm">            }</span>
<span class="cm">        }</span>
<span class="cm">        CurrMbAddr = NextMbAddress( CurrMbAddr );</span>
<span class="cm">    } while( moreDataFlag );</span>
<span class="cm">}</span>
<span class="cm">*/</span>


<span class="cm">/***************************** writing ******************************/</span>

<span class="cp">#define DBG_START \</span>
<span class="cp">    BS* b2 = (BS*)malloc(sizeof(BS)); \</span>
<span class="cp">    BSInit(b2, b-&gt;p, b-&gt;end - b-&gt;p); \</span>
<span class="cp">    H264Stream* h2 = (H264Stream*)malloc(sizeof(H264Stream));\</span>
<span class="cp">    h2-&gt;sps=h-&gt;sps; h2-&gt;pps=h-&gt;pps; h2-&gt;nal=h-&gt;nal; h2-&gt;sh=h-&gt;shs[h-&gt;num_slices];  \</span>

<span class="cp">#define DBG_END \</span>
<span class="cp">    free(h2); \</span>
<span class="cp">    free(b2); \</span>

<span class="cp">#define DBG \</span>
<span class="cp">  printf(&quot;line %d:&quot;,  __LINE__ ); \</span>
<span class="cp">  debug_bs(b); \</span>
<span class="cp">  b2-&gt;p = b2-&gt;start; b2-&gt;bits_left = 8; \</span>
<span class="cp">  </span><span class="cm">/* ReadSliceHeader(h2, b2); */</span><span class="cp">\</span>
<span class="cp">  </span><span class="cm">/* if (h2-&gt;sh-&gt;DecRefPicMarking.adaptive_ref_pic_marking_mode_flag) { printf(&quot; X&quot;); }; */</span><span class="cp"> \</span>
<span class="cp">  printf(&quot;\n&quot;); \</span>

<span class="cm">/**</span>
<span class="cm"> Write a NAL unit to a byte buffer.</span>
<span class="cm"> The NAL which is written out has a type determined by h-&gt;nal and data which comes from other fields within h depending on its type.</span>
<span class="cm"> @param[in,out]  h          the stream object</span>
<span class="cm"> @param[out]     buf        the buffer</span>
<span class="cm"> @param[in]      size       the size of the buffer</span>
<span class="cm"> @return                    the length of data actually written</span>
<span class="cm"> */</span>
<span class="c1">//7.3.1 NAL unit syntax</span>
<span class="kt">int</span> <span class="nf">WriteNalUnit</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">;</span>

    <span class="n">BS</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="n">BSNew</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">BSWriteF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">forbidden_zero_bit</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">);</span>

    <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">size</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">rbsp_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rbsp_size</span><span class="p">);</span> <span class="c1">// FIXME can use malloc?</span>
    <span class="kt">int</span> <span class="n">nal_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">BSNew</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">,</span> <span class="n">rbsp_size</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_IDR</span><span class="p">:</span>
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_NON_IDR</span><span class="p">:</span>  
        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_AUX</span><span class="p">:</span>
            <span class="n">WriteSliceLayerRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_SEI</span><span class="p">:</span>
            <span class="n">WriteSEIRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_SPS</span><span class="p">:</span> 
            <span class="n">WriteSeqParamSetRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> 
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_PPS</span><span class="p">:</span>   
            <span class="n">WritePicParamSetRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);;</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_AUD</span><span class="p">:</span>     
            <span class="n">WriteAccessUnitDelimiterRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> 
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_END_OF_SEQUENCE</span><span class="p">:</span> 
            <span class="n">WriteEndOfSeqRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">NAL_UNIT_TYPE_END_OF_STREAM</span><span class="p">:</span> 
            <span class="n">WriteEndOfStreamRBSP</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
<span class="c1">//         case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_A:</span>
<span class="c1">//         case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_B:</span>
<span class="c1">//         case NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_C:</span>
<span class="c1">//         case NAL_UNIT_TYPE_FILLER:</span>
<span class="c1">//         case NAL_UNIT_TYPE_SPS_EXT:</span>
<span class="c1">//         case NAL_UNIT_TYPE_UNSPECIFIED:</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="c1">// here comes the reserved/unspecified/ignored stuff</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">BSOverRun</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> 
    <span class="p">{</span>
        <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">);</span> 
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> 
    <span class="p">}</span>

    <span class="c1">// now get the actual size used</span>
    <span class="n">rbsp_size</span> <span class="o">=</span> <span class="n">BSPos</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">RbspToNal</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rbsp_size</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nal_size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="n">free</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">);</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">BSFree</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">rbsp_buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">nal_size</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">//7.3.2.1 Sequence parameter set RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteSeqParamSetRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set0_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set1_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set2_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set3_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set4_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set5_flag</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="cm">/* reserved_zero_2bits */</span>
    <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">level_idc</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">110</span> <span class="o">||</span>
        <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">122</span> <span class="o">||</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="o">==</span> <span class="mi">144</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">residual_colour_transform_flag</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_luma_minus8</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_chroma_minus8</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">qpprime_y_zero_transform_bypass_flag</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_scaling_matrix_present_flag</span><span class="p">);</span>
<span class="c1">//         if( sps-&gt;seq_scaling_matrix_present_flag )</span>
<span class="c1">//         {</span>
<span class="c1">//             for( i = 0; i &lt; 8; i++ )</span>
<span class="c1">//             {</span>
<span class="c1">//                 BSWriteU1(b, sps-&gt;seq_scaling_list_present_flag[i]);</span>
<span class="c1">//                 if( sps-&gt;seq_scaling_list_present_flag[i] )</span>
<span class="c1">//                 {</span>
<span class="c1">//                     if( i &lt; 6 )</span>
<span class="c1">//                         WriteScailingList( b, sps-&gt;ScalingList4x4[i], 16,sps-&gt;UseDefaultScalingMatrix4x4Flag[ i ]);</span>
<span class="c1">//                     else</span>
<span class="c1">//                         WriteScailingList( b, sps-&gt;ScalingList8x8[i-6], 64,sps-&gt;UseDefaultScalingMatrix8x8Flag[ i - 6 ] );</span>
<span class="c1">//                 }</span>
<span class="c1">//             }</span>
<span class="c1">//         }</span>
    <span class="p">}</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_frame_num_minus4</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_pic_order_cnt_lsb</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">delta_pic_order_always_zero_flag</span><span class="p">);</span>
        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_non_ref_pic</span><span class="p">);</span>
        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_top_to_bottom_field</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames_in_pic_order_cnt_cycle</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames_in_pic_order_cnt_cycle</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_ref_frame</span><span class="p">[</span> <span class="n">i</span> <span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">gaps_in_frame_num_value_allowed_flag</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_width_in_mbs_minus1</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_height_in_map_units_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="p">)</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">mb_adaptive_frame_field_flag</span><span class="p">);</span>

    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">direct_8x8_inference_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_cropping_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_cropping_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_left_offset</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_right_offset</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_top_offset</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_bottom_offset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui_parameters_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui_parameters_present_flag</span> <span class="p">)</span>
        <span class="n">WriteVUIParam</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.1.1 Scaling list syntax</span>
<span class="kt">void</span> <span class="nf">WriteScailingList</span><span class="p">(</span><span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">scalingList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sizeOfScalingList</span><span class="p">,</span> <span class="kt">int</span> <span class="n">useDefaultScalingMatrixFlag</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">lastScale</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">nextScale</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">sizeOfScalingList</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">delta_scale</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span> <span class="n">nextScale</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// FIXME will not write in most compact way - could truncate list if all remaining elements are equal</span>
            <span class="n">nextScale</span> <span class="o">=</span> <span class="n">scalingList</span><span class="p">[</span> <span class="n">j</span> <span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">useDefaultScalingMatrixFlag</span><span class="p">)</span>
                <span class="n">nextScale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="n">delta_scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">nextScale</span> <span class="o">-</span> <span class="n">lastScale</span><span class="p">)</span> <span class="o">%</span> <span class="mi">256</span> <span class="p">;</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">delta_scale</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">lastScale</span> <span class="o">=</span> <span class="n">scalingList</span><span class="p">[</span> <span class="n">j</span> <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//Appendix E.1.1 VUI parameters syntax</span>
<span class="kt">void</span>
<span class="nf">WriteVUIParam</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>

    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_info_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_idc</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_idc</span> <span class="o">==</span> <span class="n">SAR_EXTENDED</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_width</span><span class="p">);</span>
            <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_height</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_info_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_appropriate_flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_sigNALype_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_sigNALype_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_format</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_full_range_flag</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_description_present_flag</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_description_present_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_primaries</span><span class="p">);</span>
            <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">transfer_characteristics</span><span class="p">);</span>
            <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">matrix_coefficients</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_loc_info_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_loc_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_top_field</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_bottom_field</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">timing_info_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">timing_info_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_units_in_tick</span><span class="p">);</span>
        <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">time_scale</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">fixed_frame_rate_flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">WriteHRDPARAM</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">WriteHRDPARAM</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="o">||</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">low_delay_hrd_flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">pic_struct_present_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">bitstream_restriction_flag</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">bitstream_restriction_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">motion_vectors_over_pic_boundaries_flag</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bytes_per_pic_denom</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bits_per_mb_denom</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_horizontal</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_vertical</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_reorder_frames</span><span class="p">);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_dec_frame_buffering</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//Appendix E.1.2 HRD parameters syntax</span>
<span class="kt">void</span>
<span class="nf">WriteHRDPARAM</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_scale</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_scale</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iSchedSelIdx</span> <span class="o">&lt;=</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span><span class="p">;</span> <span class="n">iSchedSelIdx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cbr_flag</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">initial_cpb_removal_delay_length_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_removal_delay_length_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">dpb_output_delay_length_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">time_offset_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">UNIMPLEMENTED</span>
<span class="cm">//7.3.2.1.2 Sequence parameter set extension RBSP syntax</span>
<span class="cm">int write_seq_parameter_set_extension_rbsp(BS* b, sps_ext_t* sps_ext) {</span>
<span class="cm">    BSWriteUE(b, seq_parameter_set_id);</span>
<span class="cm">    BSWriteUE(b, aux_format_idc);</span>
<span class="cm">    if( aux_format_idc != 0 ) {</span>
<span class="cm">        BSWriteUE(b, bit_depth_aux_minus8);</span>
<span class="cm">        BSWriteU1(b, alpha_incr_flag);</span>
<span class="cm">        BSWriteU(v, alpha_opaque_value);</span>
<span class="cm">        BSWriteU(v, alpha_transparent_value);</span>
<span class="cm">    }</span>
<span class="cm">    BSWriteU1(b, additional_extension_flag);</span>
<span class="cm">    WriteRBSTrailingBits();</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="c1">//7.3.2.2 Picture parameter set RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WritePicParamSetRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i_group</span><span class="p">;</span>

    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_group</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span><span class="p">;</span> <span class="n">i_group</span><span class="o">++</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">run_length_minus1</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i_group</span> <span class="o">&lt;</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span><span class="p">;</span> <span class="n">i_group</span><span class="o">++</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">top_left</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]);</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">bottom_right</span><span class="p">[</span> <span class="n">i_group</span> <span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span>
                 <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span>
                 <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_direction_flag</span><span class="p">);</span>
            <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_rate_minus1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">IntLog2</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">),</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_id</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="p">);</span> <span class="c1">// was u(v)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_pred_flag</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_bipred_idc</span><span class="p">);</span>
    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qp_minus26</span><span class="p">);</span>
    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qs_minus26</span><span class="p">);</span>
    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">chroma_qp_index_offset</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">deblocking_filter_control_present_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">constrained_intra_pred_flag</span><span class="p">);</span>
    <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt_present_flag</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">more_rbsp_data_present</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">transform_8x8_mode_flag</span><span class="p">);</span>
<span class="c1">//        BSWriteU1(b, pps-&gt;pic_scaling_matrix_present_flag);</span>
<span class="c1">//         if( pps-&gt;pic_scaling_matrix_present_flag )</span>
<span class="c1">//         {</span>
<span class="c1">//             for( i = 0; i &lt; 6 + 2* pps-&gt;transform_8x8_mode_flag; i++ )</span>
<span class="c1">//             {</span>
<span class="c1">//                 BSWriteU1(b, pps-&gt;pic_scaling_list_present_flag[ i ]);</span>
<span class="c1">//                 if( pps-&gt;pic_scaling_list_present_flag[ i ] )</span>
<span class="c1">//                 {</span>
<span class="c1">//                     if( i &lt; 6 )</span>
<span class="c1">//                     {</span>
<span class="c1">//                         WriteScailingList( b, pps-&gt;ScalingList4x4[ i ], 16,</span>
<span class="c1">//                                       pps-&gt;UseDefaultScalingMatrix4x4Flag[ i ] );</span>
<span class="c1">//                     }</span>
<span class="c1">//                     else</span>
<span class="c1">//                     {</span>
<span class="c1">//                         WriteScailingList( b, pps-&gt;ScalingList8x8[ i - 6 ], 64,</span>
<span class="c1">//                                       pps-&gt;UseDefaultScalingMatrix8x8Flag[ i - 6 ] );</span>
<span class="c1">//                     }</span>
<span class="c1">//                 }</span>
<span class="c1">//             }</span>
<span class="c1">//         }</span>
        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">second_chroma_qp_index_offset</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.3 Supplemental enhancement information RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteSEIRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">WriteSEIMessage</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//since hei is temp, let seis list free what needs to be freed</span>
    <span class="c1">//and leave sei null</span>
    <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">WriteFFCodedNumber</span><span class="p">(</span><span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">BSWriteU8</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.2.3.1 Supplemental enhancement information message syntax</span>
<span class="kt">void</span> <span class="nf">WriteSEIMessage</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// FIXME need some way to calculate size, or write message then write size</span>
    <span class="n">WriteFFCodedNumber</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_type</span><span class="p">);</span>
    <span class="n">WriteFFCodedNumber</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">);</span>
    <span class="n">WriteSEIPayload</span><span class="p">(</span> <span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_type</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sei</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.4 Access unit delimiter RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteAccessUnitDelimiterRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span><span class="o">-&gt;</span><span class="n">primary_pic_type</span><span class="p">);</span>
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.5 End of sequence RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteEndOfSeqRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">//7.3.2.6 End of stream RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteEndOfStreamRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="c1">//7.3.2.7 Filler data RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteFillerDataRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ff_byte</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="c1">//FIXME</span>
    <span class="k">while</span><span class="p">(</span> <span class="n">BSNextBits</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFF</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span> <span class="n">ff_byte</span><span class="p">);</span>  <span class="c1">// equal to 0xFF</span>
    <span class="p">}</span>
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//7.3.2.8 Slice layer without partitioning RBSP syntax</span>
<span class="kt">void</span> <span class="nf">WriteSliceLayerRBSP</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WriteSliceHeader</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="n">SliceDataRbsp</span><span class="o">*</span> <span class="n">slice_data</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">slice_data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">slice_data</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span>
    <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="p">)</span>
        <span class="p">{</span>
           <span class="c1">// CABAC alignment bits</span>
            <span class="k">while</span> <span class="p">(</span> <span class="o">!</span> <span class="n">BSByteAligned</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">)</span> <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> 
        <span class="p">}</span>

        <span class="n">BSWriteBytes</span><span class="p">(</span> <span class="n">b</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_buf</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">-&gt;</span><span class="n">rbsp_size</span> <span class="p">);</span> 
        <span class="k">return</span><span class="p">;</span> <span class="c1">// HACK slice trailing bits already included</span>
    <span class="p">}</span>
    <span class="c1">//slice_data( ); /* all categories of slice_data( ) syntax */</span>
    <span class="n">WriteRBSPSliceTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">// UNIMPLEMENTED</span>
<span class="cm">//7.3.2.9.1 Slice data PARTITION A RBSP syntax</span>
<span class="cm">slice_data_partition_a_layer_rbsp( )</span>
<span class="cm">{</span>
<span class="cm">    WriteSliceHeader( );             // only category 2</span>
<span class="cm">    BSWriteUE(b, slice_id)</span>
<span class="cm">    write_slice_data( );               // only category 2</span>
<span class="cm">    WriteRBSPSliceTrailingBits( ); // only category 2</span>
<span class="cm">}</span>

<span class="cm">//7.3.2.9.2 Slice data PARTITION B RBSP syntax</span>
<span class="cm">slice_data_partition_b_layer_rbsp( )</span>
<span class="cm">{</span>
<span class="cm">    BSWriteUE(b, slice_id);    // only category 3</span>
<span class="cm">    if( redundant_pic_cnt_present_flag )</span>
<span class="cm">        BSWriteUE(b, redundant_pic_cnt);</span>
<span class="cm">    write_slice_data( );               // only category 3</span>
<span class="cm">    WriteRBSPSliceTrailingBits( ); // only category 3</span>
<span class="cm">}</span>

<span class="cm">//7.3.2.9.3 Slice data PARTITION C RBSP syntax</span>
<span class="cm">slice_data_partition_c_layer_rbsp( )</span>
<span class="cm">{</span>
<span class="cm">    BSWriteUE(b, slice_id);    // only category 4</span>
<span class="cm">    if( redundant_pic_cnt_present_flag )</span>
<span class="cm">        BSWriteUE(b, redundant_pic_cnt);</span>
<span class="cm">    write_slice_data( );               // only category 4</span>
<span class="cm">    rbsp_slice_trailing_bits( ); // only category 4</span>
<span class="cm">}</span>
<span class="cm">*/</span>

<span class="c1">//7.3.2.10 RBSP slice trailing bits syntax</span>
<span class="kt">void</span> <span class="nf">WriteRBSPSliceTrailingBits</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">        // 9.3.4.6 Byte stuffing process (informative)</span>
<span class="cm">        // NOTE do not write any cabac_zero_word for now - this appears to be optional</span>
<span class="cm">        while( MoreRBSPTrailingData(h, b) )</span>
<span class="cm">        {</span>
<span class="cm">            BSWriteF(b,16, 0x0000); // cabac_zero_word</span>
<span class="cm">        }</span>
<span class="cm">        */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.2.11 RBSP trailing bits syntax</span>
<span class="kt">void</span> <span class="nf">WriteRBSTrailingBits</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rbsp_stop_one_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">rbsp_alignment_zero_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">BSWriteF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">rbsp_stop_one_bit</span><span class="p">);</span> <span class="c1">// equal to 1</span>
    <span class="k">while</span><span class="p">(</span> <span class="o">!</span><span class="n">BSByteAligned</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteF</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">rbsp_alignment_zero_bit</span><span class="p">);</span> <span class="c1">// equal to 0</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.3 Slice header syntax</span>
<span class="kt">void</span> <span class="nf">WriteSliceHeader</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>    
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps_able</span><span class="p">[</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span><span class="p">];</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps_able</span><span class="p">[</span><span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span><span class="p">];</span>
    <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="p">;</span>

    <span class="c1">//DBG_START</span>
    <span class="c1">//h2-&gt;sh = (SliceHeader*)malloc(sizeof(SliceHeader));</span>

    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">first_mb_in_slice</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">);</span>
    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span><span class="p">);</span>
    <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_frame_num_minus4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">frame_num</span> <span class="p">);</span> <span class="c1">// was u(v)</span>
    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">bottom_field_flag</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">idr_pic_id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_pic_order_cnt_lsb</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_lsb</span> <span class="p">);</span> <span class="c1">// was u(v)</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt_bottom</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sps</span><span class="o">-&gt;</span><span class="n">delta_pic_order_always_zero_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt</span><span class="p">[</span> <span class="mi">1</span> <span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">direct_spatial_mv_pred_flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_P</span> <span class="p">)</span> <span class="o">||</span> 
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="o">||</span> 
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_active_override_flag</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_active_override_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span><span class="p">);</span> <span class="c1">// FIXME does this modify the pps?</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">WriteRefPicListRecorder</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_pred_flag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_P</span> <span class="p">)</span> <span class="o">||</span>
        <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_bipred_idc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">WritePredWeightTable</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">WriteDecRefPicMarking</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_I</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> 
        <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">cabac_init_idc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qp_delta</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="o">||</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SP</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sp_for_switch_flag</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qs_delta</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">deblocking_filter_control_present_flag</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disable_deblocking_filter_idc</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disable_deblocking_filter_idc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_alpha_c0_offset_div2</span><span class="p">);</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_beta_offset_div2</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">IntLog2</span><span class="p">(</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_size_in_map_units_minus1</span> <span class="o">+</span>
                               <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_change_rate_minus1</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">),</span>
                   <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_group_change_cycle</span> <span class="p">);</span> <span class="c1">// was u(v) // FIXME add 2?</span>
    <span class="p">}</span>
    <span class="c1">//bs_print_state(b);</span>
    <span class="c1">//free(h2-&gt;sh);</span>
    <span class="c1">//DBG_END</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="c1">//7.3.3.1 Reference picture list reordering syntax</span>
<span class="kt">void</span> <span class="nf">WriteRefPicListRecorder</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="c1">// FIXME should be an array</span>

    <span class="k">if</span><span class="p">(</span> <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_I</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_SI</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">long_term_pic_num</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">long_term_pic_num</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.3.2 Prediction weight table syntax</span>
<span class="kt">void</span> <span class="nf">WritePredWeightTable</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">;</span>
    <span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_log2_weight_denom</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_log2_weight_denom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]);</span>
            <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]);</span>
                    <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l0</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">IsSliceType</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">SH_SLICE_TYPE_B</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_weight_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">]);</span>
                <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_offset_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1_flag</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_weight_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]);</span>
                        <span class="n">BSWriteSE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_offset_l1</span><span class="p">[</span> <span class="n">i</span> <span class="p">][</span> <span class="n">j</span> <span class="p">]);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//7.3.3.3 Decoded reference picture marking syntax</span>
<span class="kt">void</span> <span class="nf">WriteDecRefPicMarking</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">BS</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">];</span>
    <span class="c1">// FIXME should be an array</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">no_output_of_prior_pics_flag</span><span class="p">);</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_reference_flag</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">BSWriteU1</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">adaptive_ref_pic_marking_mode_flag</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">adaptive_ref_pic_marking_mode_flag</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">difference_of_pic_nums_minus1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_pic_num</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span>
                    <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_frame_idx</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">==</span> <span class="mi">4</span> <span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">BSWriteUE</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">max_long_term_frame_idx_plus1</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************** debug ******************************/</span>

<span class="kt">void</span> <span class="nf">DebugSPS</span><span class="p">(</span><span class="n">SPS</span><span class="o">*</span> <span class="n">sps</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;======= SPS =======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; profile_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">profile_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set0_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set0_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set1_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set1_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set2_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set2_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set3_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set3_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set4_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set4_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constraint_set5_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">constraint_set5_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; reserved_zero_2bits : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">reserved_zero_2bits</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; level_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">level_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; seq_parameter_set_id : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; chroma_format_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">chroma_format_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; residual_colour_transform_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">residual_colour_transform_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; bit_depth_luma_minus8 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_luma_minus8</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; bit_depth_chroma_minus8 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">bit_depth_chroma_minus8</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; qpprime_y_zero_transform_bypass_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">qpprime_y_zero_transform_bypass_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; seq_scaling_matrix_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">seq_scaling_matrix_present_flag</span> <span class="p">);</span>
    <span class="c1">//  int seq_scaling_list_present_flag[8];</span>
    <span class="c1">//  void* ScalingList4x4[6];</span>
    <span class="c1">//  int UseDefaultScalingMatrix4x4Flag[6];</span>
    <span class="c1">//  void* ScalingList8x8[2];</span>
    <span class="c1">//  int UseDefaultScalingMatrix8x8Flag[2];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; log2_max_frame_num_minus4 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_frame_num_minus4</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_order_cnt_type : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_type</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   log2_max_pic_order_cnt_lsb : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">log2_max_pic_order_cnt_lsb</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   delta_pic_order_always_zero_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">delta_pic_order_always_zero_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   offset_for_non_ref_pic : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_non_ref_pic</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   offset_for_top_to_bottom_field : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">offset_for_top_to_bottom_field</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   num_ref_frames_in_pic_order_cnt_cycle : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames_in_pic_order_cnt_cycle</span> <span class="p">);</span>
    <span class="c1">//  int offset_for_ref_frame[256];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_frames : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">num_ref_frames</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; gaps_in_frame_num_value_allowed_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">gaps_in_frame_num_value_allowed_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_width_in_mbs_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_width_in_mbs_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_height_in_map_units_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">pic_height_in_map_units_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; frame_mbs_only_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_mbs_only_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; mb_adaptive_frame_field_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">mb_adaptive_frame_field_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; direct_8x8_inference_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">direct_8x8_inference_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; frame_cropping_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_cropping_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   frame_crop_left_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_left_offset</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   frame_crop_right_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_right_offset</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   frame_crop_top_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_top_offset</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   frame_crop_bottom_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">frame_crop_bottom_offset</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; vui_parameters_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui_parameters_present_flag</span> <span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== VUI ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; aspect_ratio_info_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_info_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   aspect_ratio_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">aspect_ratio_idc</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;     sar_width : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_width</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;     sar_height : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">sar_height</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; overscan_info_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_info_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   overscan_appropriate_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">overscan_appropriate_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; video_sigNALype_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_sigNALype_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   video_format : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_format</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   video_full_range_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">video_full_range_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   colour_description_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_description_present_flag</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;     colour_primaries : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">colour_primaries</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   transfer_characteristics : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">transfer_characteristics</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   matrix_coefficients : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">matrix_coefficients</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; chroma_loc_info_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_loc_info_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   chroma_sample_loc_type_top_field : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_top_field</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   chroma_sample_loc_type_bottom_field : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">chroma_sample_loc_type_bottom_field</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; timing_info_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">timing_info_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   num_units_in_tick : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_units_in_tick</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   time_scale : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">time_scale</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   fixed_frame_rate_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">fixed_frame_rate_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; nal_hrd_parameters_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">nal_hrd_parameters_present_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; vcl_hrd_parameters_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">vcl_hrd_parameters_present_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   low_delay_hrd_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">low_delay_hrd_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_struct_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">pic_struct_present_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; bitstream_restriction_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">bitstream_restriction_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   motion_vectors_over_pic_boundaries_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">motion_vectors_over_pic_boundaries_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   max_bytes_per_pic_denom : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bytes_per_pic_denom</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   max_bits_per_mb_denom : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_bits_per_mb_denom</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   log2_max_mv_length_horizontal : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_horizontal</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   log2_max_mv_length_vertical : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">log2_max_mv_length_vertical</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   num_reorder_frames : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">num_reorder_frames</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   max_dec_frame_buffering : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">vui</span><span class="p">.</span><span class="n">max_dec_frame_buffering</span> <span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== HRD ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; cpb_cnt_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; bit_rate_scale : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_scale</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; cpb_size_scale : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_scale</span> <span class="p">);</span>
    <span class="kt">int</span> <span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">iSchedSelIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iSchedSelIdx</span> <span class="o">&lt;=</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_cnt_minus1</span><span class="p">;</span> <span class="n">iSchedSelIdx</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   bit_rate_value_minus1[%d] : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iSchedSelIdx</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">bit_rate_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   cpb_size_value_minus1[%d] : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iSchedSelIdx</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_size_value_minus1</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;   cbr_flag[%d] : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iSchedSelIdx</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cbr_flag</span><span class="p">[</span><span class="n">iSchedSelIdx</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; initial_cpb_removal_delay_length_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">initial_cpb_removal_delay_length_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; cpb_removal_delay_length_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">cpb_removal_delay_length_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; dpb_output_delay_length_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">dpb_output_delay_length_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; time_offset_length : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sps</span><span class="o">-&gt;</span><span class="n">hrd</span><span class="p">.</span><span class="n">time_offset_length</span> <span class="p">);</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>


<span class="kt">void</span> <span class="nf">DebugPPS</span><span class="p">(</span><span class="n">PPS</span><span class="o">*</span> <span class="n">pps</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;======= PPS =======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_parameter_set_id : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; seq_parameter_set_id : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">seq_parameter_set_id</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; entropy_coding_mode_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">entropy_coding_mode_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_order_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_order_present_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_slice_groups_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_slice_groups_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_group_map_type : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">slice_group_map_type</span> <span class="p">);</span>    
    <span class="c1">//  int top_left[8];</span>
    <span class="c1">//  int bottom_right[8];</span>
    <span class="c1">//  int slice_group_change_direction_flag;</span>
    <span class="c1">//  int slice_group_change_rate_minus1;</span>
    <span class="c1">//  int pic_size_in_map_units_minus1;</span>
    <span class="c1">//  int slice_group_id[256]; // FIXME what size?</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_idx_l0_active_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_idx_l1_active_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; weighted_pred_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_pred_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; weighted_bipred_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">weighted_bipred_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_init_qp_minus26 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qp_minus26</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_init_qs_minus26 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">pic_init_qs_minus26</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; chroma_qp_index_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">chroma_qp_index_offset</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; deblocking_filter_control_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">deblocking_filter_control_present_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; constrained_intra_pred_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">constrained_intra_pred_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; redundant_pic_cnt_present_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt_present_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; transform_8x8_mode_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">transform_8x8_mode_flag</span> <span class="p">);</span>
<span class="c1">//    printf(&quot; pic_scaling_matrix_present_flag : %d \n&quot;, pps-&gt;pic_scaling_matrix_present_flag );</span>
    <span class="c1">//  int pic_scaling_list_present_flag[8];</span>
    <span class="c1">//  void* ScalingList4x4[6];</span>
    <span class="c1">//  int UseDefaultScalingMatrix4x4Flag[6];</span>
    <span class="c1">//  void* ScalingList8x8[2];</span>
    <span class="c1">//  int UseDefaultScalingMatrix8x8Flag[2];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; second_chroma_qp_index_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pps</span><span class="o">-&gt;</span><span class="n">second_chroma_qp_index_offset</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DebugSliceHeader</span><span class="p">(</span><span class="n">SliceHeader</span><span class="o">*</span> <span class="n">sh</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;======= Slice Header =======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; first_mb_in_slice : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">first_mb_in_slice</span> <span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">slice_type_name</span><span class="p">;</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_P</span> <span class="p">:</span>       <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;P slice&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_B</span> <span class="p">:</span>       <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;B slice&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_I</span> <span class="p">:</span>       <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;I slice&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_SP</span> <span class="p">:</span>      <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;SP slice&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_SI</span> <span class="p">:</span>      <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;SI slice&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_P_ONLY</span> <span class="p">:</span>  <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;P slice only&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_B_ONLY</span> <span class="p">:</span>  <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;B slice only&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_I_ONLY</span> <span class="p">:</span>  <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;I slice only&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_SP_ONLY</span> <span class="p">:</span> <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;SP slice only&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">SH_SLICE_TYPE_SI_ONLY</span> <span class="p">:</span> <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;SI slice only&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span> <span class="o">:</span>                    <span class="n">slice_type_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_type : %d ( %s ) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_type</span><span class="p">,</span> <span class="n">slice_type_name</span> <span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_parameter_set_id : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_parameter_set_id</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; frame_num : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">frame_num</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; field_pic_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">field_pic_flag</span> <span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot; bottom_field_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">bottom_field_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; idr_pic_id : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">idr_pic_id</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; pic_order_cnt_lsb : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">pic_order_cnt_lsb</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; delta_pic_order_cnt_bottom : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">delta_pic_order_cnt_bottom</span> <span class="p">);</span>
    <span class="c1">// int delta_pic_order_cnt[ 2 ];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; redundant_pic_cnt : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">redundant_pic_cnt</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; direct_spatial_mv_pred_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">direct_spatial_mv_pred_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_idx_active_override_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_active_override_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_idx_l0_active_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l0_active_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; num_ref_idx_l1_active_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">num_ref_idx_l1_active_minus1</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; cabac_init_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">cabac_init_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_qp_delta : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qp_delta</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; sp_for_switch_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">sp_for_switch_flag</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_qs_delta : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_qs_delta</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; disable_deblocking_filter_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">disable_deblocking_filter_idc</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_alpha_c0_offset_div2 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_alpha_c0_offset_div2</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_beta_offset_div2 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_beta_offset_div2</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_group_change_cycle : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_group_change_cycle</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; slice_data_bit_offset : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">slice_data_bit_offset</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Prediction Weight Table ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; luma_log2_weight_denom : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">luma_log2_weight_denom</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; chroma_log2_weight_denom : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">PredWeightTable</span><span class="p">.</span><span class="n">chroma_log2_weight_denom</span> <span class="p">);</span>
     <span class="c1">//   printf(&quot; luma_weight_l0_flag : %d \n&quot;, sh-&gt;PredWeightTable.luma_weight_l0_flag );</span>
        <span class="c1">// int luma_weight_l0[64];</span>
        <span class="c1">// int luma_offset_l0[64];</span>
    <span class="c1">//    printf(&quot; chroma_weight_l0_flag : %d \n&quot;, sh-&gt;PredWeightTable.chroma_weight_l0_flag );</span>
        <span class="c1">// int chroma_weight_l0[64][2];</span>
        <span class="c1">// int chroma_offset_l0[64][2];</span>
     <span class="c1">//   printf(&quot; luma_weight_l1_flag : %d \n&quot;, sh-&gt;PredWeightTable.luma_weight_l1_flag );</span>
        <span class="c1">// int luma_weight_l1[64];</span>
        <span class="c1">// int luma_offset_l1[64];</span>
    <span class="c1">//    printf(&quot; chroma_weight_l1_flag : %d \n&quot;, sh-&gt;PredWeightTable.chroma_weight_l1_flag );</span>
        <span class="c1">// int chroma_weight_l1[64][2];</span>
        <span class="c1">// int chroma_offset_l1[64][2];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Ref Pic List Reordering ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; ref_pic_list_reordering_flag_l0 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; ref_pic_list_reordering_flag_l1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">ref_pic_list_reordering_flag_l1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; reordering_of_pic_nums_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">reordering_of_pic_nums_idc</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; abs_diff_pic_num: %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">abs_diff_pic_num</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; long_term_pic_num : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">RefPicListRecorder</span><span class="p">.</span><span class="n">long_term_pic_num</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== Decoded Ref Pic Marking ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; no_output_of_prior_pics_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">no_output_of_prior_pics_flag</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; long_term_reference_flag : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_reference_flag</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; memory_management_control_operation : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">memory_management_control_operation</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; difference_of_pic_nums_minus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">difference_of_pic_nums_minus1</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; long_term_pic_num : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_pic_num</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; long_term_frame_idx : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">long_term_frame_idx</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; max_long_term_frame_idx_plus1 : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">DecRefPicMarking</span><span class="p">.</span><span class="n">max_long_term_frame_idx_plus1</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DebugAUD</span><span class="p">(</span><span class="n">AUD</span><span class="o">*</span> <span class="n">aud</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;======= Access Unit Delimiter =======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">primary_pic_type_name</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">aud</span><span class="o">-&gt;</span><span class="n">primary_pic_type</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_I</span> <span class="p">:</span>       <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_IP</span> <span class="p">:</span>      <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I, P&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_IPB</span> <span class="p">:</span>     <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I, P, B&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_SI</span> <span class="p">:</span>      <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;SI&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_SISP</span> <span class="p">:</span>    <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;SI, SP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_ISI</span> <span class="p">:</span>     <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I, SI&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_ISIPSP</span> <span class="p">:</span>  <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I, SI, P, SP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">AUD_PRIMARY_PIC_TYPE_ISIPSPB</span> <span class="p">:</span> <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;I, SI, P, SP, B&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span> <span class="o">:</span> <span class="n">primary_pic_type_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; primary_pic_type : %d ( %s ) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aud</span><span class="o">-&gt;</span><span class="n">primary_pic_type</span><span class="p">,</span> <span class="n">primary_pic_type_name</span> <span class="p">);</span>
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="kt">void</span> <span class="nf">DebugSEIS</span><span class="p">(</span> <span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SEI</span><span class="o">**</span> <span class="n">seis</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">seis</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_seis</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">num_seis</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;======= SEI =======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">SEIype_name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_seis</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">SEI</span><span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="n">seis</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">payload_type</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="k">case</span> <span class="nl">SEIYPE_BUFFERING_PERIOD</span> <span class="p">:</span>          <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Buffering period&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_PIC_TIMING</span> <span class="p">:</span>                <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Pic timing&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_PAN_SCAN_RECT</span> <span class="p">:</span>             <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Pan scan rect&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_FILLER_PAYLOAD</span> <span class="p">:</span>            <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Filler payload&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_USER_DATA_REGISTERED_ITU_T_T35</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;User data registered ITU-T T35&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_USER_DATA_UNREGISTERED</span> <span class="p">:</span>    <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;User data unregistered&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_RECOVERY_POINT</span> <span class="p">:</span>            <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Recovery point&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_DEC_REF_PIC_MARKING_REPETITION</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Dec ref pic marking repetition&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_SPARE_PIC</span> <span class="p">:</span>                 <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Spare pic&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_SCENE_INFO</span> <span class="p">:</span>                <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Scene info&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_SUB_SEQ_INFO</span> <span class="p">:</span>              <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Sub seq info&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_SUB_SEQ_LAYER_CHARACTERISTICS</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Sub seq layer characteristics&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_SUB_SEQ_CHARACTERISTICS</span> <span class="p">:</span>   <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Sub seq characteristics&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_FULL_FRAME_FREEZE</span> <span class="p">:</span>         <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Full frame freeze&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_FULL_FRAME_FREEZE_RELEASE</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Full frame freeze release&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_FULL_FRAME_SNAPSHOT</span> <span class="p">:</span>       <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Full frame snapshot&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_PROGRESSIVE_REFINEMENT_SEGMENT_VAART</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Progressive refinement segment start&quot;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_PROGRESSIVE_REFINEMENT_SEGMENT_END</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Progressive refinement segment end&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_MOTION_CONSTRAINED_SLICE_GROUP_SET</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Motion constrained slice group set&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_FILM_GRAIN_CHARACTERISTICS</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Film grain characteristics&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_DEBLOCKING_FILTER_DISPLAY_PREFERENCE</span> <span class="p">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Deblocking filter display preference&quot;</span><span class="p">;</span><span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">SEIYPE_STEREO_VIDEO_INFO</span> <span class="p">:</span>         <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Stereo video info&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span> <span class="n">SEIype_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;=== %s ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SEIype_name</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; payloadType : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">payload_type</span> <span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; payloadSize : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">payload_size</span> <span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot; payload : &quot;</span> <span class="p">);</span>
        <span class="n">DebugBytes</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">payload_ptr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">payload_size</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> Print the contents of a NAL unit to standard output.</span>
<span class="cm"> The NAL which is printed out has a type determined by nal and data </span>
<span class="cm"> which comes from other fields within h depending on its type.</span>
<span class="cm"> @param[in]      h          the stream object</span>
<span class="cm"> @param[in]      nal        the nal unit</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">DebugNal</span><span class="p">(</span><span class="n">H264Stream</span><span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">NAL</span><span class="o">*</span> <span class="n">nal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;==================== NAL ====================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; forbidden_zero_bit : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">forbidden_zero_bit</span> <span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; nal_ref_idc : %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_ref_idc</span> <span class="p">);</span>
    <span class="c1">// TODO make into subroutine</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">nal_unit_type_name</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_UNSPECIFIED</span> <span class="p">:</span>                   <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Unspecified&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_NON_IDR</span> <span class="p">:</span>           
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice of a non-IDR picture&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_A</span> <span class="p">:</span>  
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice data PARTITION A&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_B</span> <span class="p">:</span>  
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice data PARTITION B&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_DATA_PARTITION_C</span> <span class="p">:</span> 
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice data PARTITION C&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_IDR</span> <span class="p">:</span>              
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice of an IDR picture&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_SEI</span> <span class="p">:</span>                    
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Supplemental enhancement information (SEI)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_SPS</span> <span class="p">:</span>                      
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Sequence parameter set&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_PPS</span> <span class="p">:</span>                        
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Picture parameter set&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_AUD</span> <span class="p">:</span>                       
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Access unit delimiter&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_END_OF_SEQUENCE</span> <span class="p">:</span>           
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;End of sequence&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_END_OF_STREAM</span> <span class="p">:</span>             
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;End of stream&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_FILLER</span> <span class="p">:</span>                    
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Filler data&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_SPS_EXT</span> <span class="p">:</span>                   
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Sequence parameter set extension&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="c1">// 14..18    // Reserved</span>
    <span class="k">case</span>  <span class="nl">NAL_UNIT_TYPE_CODED_SLICE_AUX</span> <span class="p">:</span>            
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Coded slice of an auxiliary coded picture without partitioning&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="c1">// 20..23    // Reserved</span>
        <span class="c1">// 24..31    // Unspecified</span>
    <span class="k">default</span> <span class="o">:</span>                                         
        <span class="n">nal_unit_type_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; nal_unit_type : %d ( %s ) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span><span class="p">,</span> <span class="n">nal_unit_type_name</span> <span class="p">);</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_CODED_SLICE_NON_IDR</span><span class="p">)</span>
     <span class="n">DebugSliceHeader</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">]);</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_CODED_SLICE_IDR</span><span class="p">)</span>
     <span class="n">DebugSliceHeader</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">shs</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">num_slices</span><span class="p">]);</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_SPS</span><span class="p">)</span> 
        <span class="n">DebugSPS</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">);</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_PPS</span><span class="p">)</span> 
        <span class="n">DebugPPS</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">pps</span><span class="p">);</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_AUD</span><span class="p">)</span> 
        <span class="n">DebugAUD</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">aud</span><span class="p">);</span> 
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nal</span><span class="o">-&gt;</span><span class="n">nal_unit_type</span> <span class="o">==</span> <span class="n">NAL_UNIT_TYPE_SEI</span><span class="p">)</span> 
        <span class="n">DebugSEIS</span><span class="p">(</span> <span class="n">h</span> <span class="p">);</span> 
<span class="p">}</span><span class="c1">// NOLINT(readability/fn_size)</span>

<span class="kt">void</span> <span class="nf">DebugBytes</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</body>
</html>
